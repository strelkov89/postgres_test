# PostgreSQL. Тестовое задание.

Контекст исполнения — PostgreSQL 15 (допустимы и приветствуются CTE, lateral derived-ы, оконные функции и пр., с целью как оптимизации запросов, так и демонстрации навыков).

Задание 1. Написать серверную рутину или рутины (процедуру или функцию), которая заполняет рандомными значениями таблицу цен облигаций на биржах на период 62 дня в прошлое от переданной даты запуска (если не передана — от даты запуска).

A. Реализуемый функционал:
Определение таблицы и процедура её заполнения данными для тестирования

B. Особенности:
В таблице фиксируются id биржи, id облигации, дата и две цены бумаги на бирже на дату.
Структура таблицы (название exch_quotes_archive):

    • идентификатор биржи (название поля - exchange_id)
    • идентификатор облигации (название поля - bond_id)
    • дата торгов на бирже (название поля - trading_date)
    • цена bid (название поля — bid; nullable, дробное число, цена в долях от номинала бумаги, signed, бОльшая часть значений как правило лежит диапазоне [-0.01;2], но возможны любые числа; null значит, что данные на дату отсутствуют).
    • цена ask (название поля — ask; nullable, те же характеристики, что у bid)

Поля:
exchange_id
bond_id
trading_date
bid
ask

Потенциальный ключ - exchange_id + bond_id + trading_date. Сделать его ПК или просто уникальным при автоинкрементном ПК, или ещё как-то - на усмотрение программиста.
Конкретные типы полей, ключи, индексы, партиции, дополнительные поля - на усмотрение программиста.

Идентификаторы бирж: [1, 4, 72, 99, 250, 399, 502, 600]
Диапазон идентификаторов облигаций: [1; 200]
На каждую бумагу из списка торги ведутся только на 7-ми биржах из 8-ми, определите случайным образом, на какой нет, в процессе реализации процедуры.

Процедура должна заполнять данную таблицу на 62 дня в прошлое от якорной даты случайными ценами.
Якорная дата — аргумент на входе функции (нас устроит и процедура, принимающая сегодняшнюю дату (дату запуска процедуры) за якорную).

При желании — можно обеспечить наличие записей, когда bid, либо ask не заполнены (null).
Не может быть записи, у которой и bid, и ask не заполнены (одно из полей может быть null, оба — нет).

Обязательное условие - для всех бирж отсутствуют любые записи строго по субботам и воскресеньям.

C. Ожидаемый результат:

    1. SQL определение таблицы exch_quotes_archive
    2. SQL-код процедуры, запустив которую на нашем сервере мы получим заполненную таблицу


Задание 2. Реализовать только серверными средствами PostgreSQL (без выноса вычислений в клиентское приложение) нижеописанный функционал.

A. Функционал для реализации:

Выборка средних цен (и bid, и ask) ото всех поставщиков (бирж) по каждой облигации за последние 14 дней от даты запуска запроса/процедуры, при этом включая так же и даты, на которые не было торгов (нет записей в таблице).
Строго 14 календарных дней (то есть субботы и воскресенья, на которые нет записей, должны быть в результирующем рекордсете как null-овые значения).
На каждую пару облигация-дата должна быть запись со средними от всех бирж ценами по облигации на дату.

B. Ожидаемый результат:

SQL-код запроса без процедур, переменных и пр.

Опционально: Задание 3. По результатам запроса 2: посчитать скользящее среднее от агрегированного среднего за 14 дней по каждой бумаге серверными средствами Postgres (без выноса вычислений в клиентское приложение).

A. Функционал для реализации:

Посчитать скользящие средние цены от агрегированных на дату средних цен по бумаге ото всех поставщиков за 14 дней по каждой бумаге. Окно — 3 дня.

B. Ожидаемый результат:

Опционально: SQL-код запроса/рутин